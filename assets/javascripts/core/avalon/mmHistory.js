define(["avalon"],function(t){function e(t){return!t||t===window.name||"_self"===t||"top"===t&&window==window.top}function i(t){for(var e,i=0;e=t[i++];)if("A"===e.nodeName)return e}function r(t,e){(e=document.getElementById(t))?e.scrollIntoView():(e=i(document.getElementsByName(t)))?e.scrollIntoView():window.scrollTo(0,0)}var n=t.History=function(){this.location=window.location,this.history=window.history};n.started=!1,n.IEVersion=function(){var t=document.documentMode;return t?t:window.XMLHttpRequest?7:6}(),n.defaults={root:"/",html5Mode:!1,hashPrefix:"!",iframeID:null,interval:50,fireAnchor:!0,routeElementJudger:t.noop};var a=window.VBArray&&n.IEVersion<=7,o=!!window.history.pushState,s=!(!("onhashchange"in window)||window.VBArray&&a);return n.started=!1,n.prototype={constructor:n,atRoot:function(){var t=this.location.pathname.replace(/[^\/]$/,"$&/");return t===this.root&&!this.getSearch()},matchRoot:function(){var t=this.decodeFragment(this.location.pathname),e=t.slice(0,this.root.length-1)+"/";return e===this.root},decodeFragment:function(t){return decodeURI(t.replace(/%25/g,"%2525"))},getSearch:function(){var t=this.location.href.replace(/#.*/,"").match(/\?.+/);return t?t[0]:""},getHash:function(t){var e=(t||this).location.href;return this._getHash(e.slice(e.indexOf("#")))},_getHash:function(t){return 0===t.indexOf("#/")?decodeURI(t.slice(2)):0===t.indexOf("#!/")?decodeURI(t.slice(3)):""},getPath:function(){var t=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===t.charAt(0)?t.slice(1):t},getFragment:function(t){return null==t&&(t="popstate"===this.monitorMode?this.getPath():this.getHash()),t.replace(/^[#\/]|\s+$/g,"")},start:function(e){function i(){if(!n.started)return!1;var t=a.getFragment();return t===a.fragment&&a.iframe&&(t=a.getHash(a.iframe.contentWindow)),t!==a.fragment&&(a.iframe&&a.navigate(t),void a.fireUrlChange())}if(n.started)throw new Error("avalon.history has already been started");e=e||{},e.basepath&&(e.root=e.basepath,delete e.basepath),n.started=!0,this.options=t.mix({root:"/"},n.defaults,e),this.html5Mode=!!this.options.html5Mode,this.monitorMode=this.html5Mode?"popstate":"hashchange",o||(this.html5Mode&&(t.log("如果浏览器不支持HTML5 pushState，强制使用hash hack!"),this.html5Mode=!1),this.monitorMode="hashchange"),s||(this.monitorMode="iframepoll"),this.prefix="#"+this.options.hashPrefix+"/",this.root=("/"+this.options.root+"/").replace(/^\/+|\/+$/g,"/"),this.fragment=this.getFragment();var r=this.atRoot();"popstate"===this.monitorMode&&o&&r&&this.navigate(this.getHash(),{replace:!0});var a=this;switch(this.monitorMode){case"popstate":this._checkUrlChange=t.bind(window,"popstate",i);break;case"hashchange":this._checkUrlChange=t.bind(window,"hashchange",i);break;case"iframepoll":this._intervalID=setInterval(i,this.interval),t.ready(function(){var t=a.iframe=document.createElement("iframe");t.src="javascript:0",t.style.display="none",t.tabIndex=-1;var e=document.body,i=e.insertBefore(t,e.firstChild).contentWindow;i.document.open(),i.document.close(),i.location.hash=a.prefix+a.fragment})}if(!this.options.silent)return this.fireUrlChange()},stop:function(){switch(this.monitorMode){case"popstate":t.unbind(window,"popstate",this._checkUrlChange);break;case"hashchange":t.unbind(window,"hashchange",this._checkUrlChange);break;case"iframepoll":this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),clearInterval(this._intervalID)}n.started=!1},fireUrlChange:function(e){e=this.fragment=this.getFragment(e),t.router&&(t.router.setLastPath(e),t.router.navigate(e)),this.options.fireAnchor&&r(e.replace(/\?.*/g,""))},navigate:function(t,e){if(!n.started)return!1;e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||"");var i=this.root;""!==t&&"?"!==t.charAt(0)||(i=i.slice(0,-1)||"/");var r=i+t;if(t=this.decodeFragment(t.replace(/#.*$/,"")),this.fragment!==t){if(this.fragment=t,"popstate"===this.monitorMode)this.history[e.replace?"replaceState":"pushState"]({},document.title,r);else{if(this.options.html5Mode)return this.location.assign(r);if(this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getHash(this.iframe.contentWindow)){var a=this.iframe.contentWindow;e.replace||(a.document.open(),a.document.close()),this._updateHash(a.location,t,e.replace)}}return e.trigger?this.fireUrlChange(t):void 0}},_updateHash:function(t,e,i){if(i){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+this.prefix+e)}else t.hash=this.prefix+e}},t.history=new n,t.bind(document,"click",function(i){var r="defaultPrevented"in i?i.defaultPrevented:i.returnValue===!1;if(n.started&&!r&&!i.ctrlKey&&!i.metaKey&&2!==i.which){for(var a=i.target;"A"!==a.nodeName;)if(a=a.parentNode,!a||"BODY"===a.tagName)return;if(e(a.target)){var o=a.getAttribute("href",2)||a.getAttribute("xlink:href"),s=t.history.prefix;if(null===o)return;var h=o.replace(s,"").trim();if(0!==o.indexOf(s)||""===h){var c=t.history.options.routeElementJudger;h=c(a,o),h===!0&&(h=o)}h&&(i.preventDefault(),t.history.navigate(h,!0))}}}),t});